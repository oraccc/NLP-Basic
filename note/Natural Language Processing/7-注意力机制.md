## 注意力机制



### §7.1 注意力机制(Attention Mechanism)简介

在 [编码器—解码器（seq2seq）](https://github.com/oraccc/NLP-Basic/blob/master/note/Natural%20Language%20Processing/6-Seq2Seq.md) ⼀节里，解码器在各个时间步依赖相同的背景变量来获取输入序列信息。当编码器为循环神经网络时，背景变量来自它最终时间步的隐藏状态。

现在，让我们再次思考上一节提到的翻译例子：

> 输入为英语序列`“They”,“are”,“watching”,“.”`，输出为法语序列`“Ils”,“regardent”,“.”`。
>
> 不难想到，解码器在生成输出序列中的每⼀个词时可能只需利用输入序列某⼀部分的信息。例如，在输出序列的时间步1，解码器可以主要依赖`“They”,“are”`的信息来生成`“Ils”`，在时间步2则主要使用来自`“watching”`的编码信息⽣成`“regardent”`，最后在时间步3则直接映射句号`“.”`。

这看上去就像是在解码器的每一时间步对输入序列中**不同时间步的表征或编码信息分配不同的注意力**⼀样。这也是注意力机制的由来。

仍然以循环神经网络为例，注意力机制通过对编码器所有时间步的隐藏状态**做加权平均来得到背景变量**。解码器在**每一时间步调整这些权重**，即注意力权重，从而能够在不同时间步分别关注输入序列中的不同部分并编码进相应时间步的背景变量。

在注意力机制中，解码器的每⼀时间步将使用**可变的背景变量**。记 $c_{t'}$ 是解码器在时间步 $t'$ 的背景变量，那么解码器在该时间步的隐藏状态可以改写为：
$$
s_{t'}=g(y_{t'-1}, c_{t'}, s_{t'-1})
$$
问题的关键是

* 如何计算背景变量 $c_{t'}$
* 如何用背景变量来更新隐藏状态 $s_{t'}$

---



### §7.2 解编码器中的注意力机制

#### 计算背景变量

下图描绘了注意力机制如何为**解码器**在**时间步 2** 计算背景变量

<img src="https://raw.githubusercontent.com/oraccc/NLP-Basic/master/img/attention/cal-background.png" width="550" />

* 函数 $a$ 根据**解码器在时间步 1 **的隐藏状态和**编码器在各个时间步**的隐藏状态计算softmax运算的输入
* softmax运算输出**概率分布**并对编码器各个时间步的隐藏状态做**加权平均**，从而得到背景变量

令编码器在时间步 $t$ 的隐藏状态为 $h_t$，且总时间步数为 $T$。那么解码器在时间步 $t′$ 的背景变量为所有编码器隐藏状态的加权平均：
$$
c_{t'} = \sum_{t=1}^T \alpha_{t't}h_{t}
$$

##### 矢量化计算背景变量

我们还可以对注意力机制采用更高效的矢量化计算。我们先定义，在上面的例子中，**查询项为解码器的隐藏状态**，**键项和值项均为编码器的隐藏状态**。

> 广义上，注意力机制的输入包括查询项以及⼀⼀对应的键项和值项，其中值项是需要加权平均的⼀组项。在加权平均中，值项的权重来自查询项以及与该值项对应的键项的计算。

让我们考虑⼀个常见的简单情形，即编码器和解码器的隐藏单元个数均为 $h$ ,并且函数 $a(s,h)=s^Th$

* 假设我们希望根据解码器单个隐藏状态 $s_{t'−1}$ 和编码器所有隐藏状态 $h_t, t = 1, . . . , T$ 来计算背景向量 $c_{t'}$ 
* 将查询矩阵 $Q$ 设为 $s_{t'-1}^{T}$, 并令键项矩阵 $K$ 和值项矩阵 $V$ 相同且第 $t$ 行均为 $h_t^T$
* 只需要矢量化计算 $softmax(QK^T)V$ 即可算出转置后的背景向量 $c_{t'}^T$

当查询项矩阵 $Q$ 的行数为 $n$ 时，上式将得到 $n$ 行的输出矩阵。输出矩阵与查询项矩阵在相同行上⼀⼀对应。



#### 更新隐藏状态

以门控循环单元（GRU）为例

对GRU的设计稍作修改，从而变换上⼀时间步 $t'−1$ 的输出 $y_{t'−1}$、隐藏状态 $s_{t'−1}$ 和当前时间步 $t'$ 的含注意力机制的背景变量 $c_{t'}$。

解码器在时间步 $t'$ 的隐藏状态为：
$$
s_{t'} = z_{t'} \odot s_{t'-1} + (1-z_{t'}) \odot \tilde{s}_{t'}
$$

其中的重置门、更新门和候选隐藏状态分别为
$$
r_{t'} = \sigma(W_{yr}y_{t'-1} + W_{sr}s_{t'-1} + W_{cr}c_{t'} + b_r) \\
z_{t'} = \sigma(W_{yz}y_{t'-1} + W_{sz}s_{t'-1} + W_{cz}c_{t'} + b_z) \\
\tilde{s}_{t'} = tanh(W_{ys}y_{t'-1} + W_{ss}(s_{t'-1} \odot r_{t'} + W_{cs}c_{t'} + b_s)
$$
---

